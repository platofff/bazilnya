<!DOCTYPE HTML>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
	integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="styles.css">

<title>МЕТАПРОГ.ОНЛАЙН</title>

<header>
	<h1>
		<strong style="margin:0;padding:0">
			МЕТАПРОГ.ОНЛАЙН Web
		</strong>
	</h1>
</header>

<body>
	<div id="loginForm">
		Введите данные своей учетной записи ВКонтакте для входа:
		<input class="form-control" id="login" , placeholder="Номер телефона или логин">
		<input class="form-control" id="pass" type="password" placeholder="Пароль">
		<button class="btn btn-primary" onclick="doLogin()">Отправить</button>
	</div>
	<footer>
		Version 0.2.0 by AnImEsHnIk2281337
	</footer>
	<div id="chat" hidden="true">
		<input style="display:inline-block" class="form-control" id="mesText"></input>
		<button onclick="message()" id="send" class="btn btn-primary">Отправить</button>
		<div id="messages" style="overflow-y:auto;height:70%">
</body>


<script>
	let socket, username;
	if (window.location.href.includes('https://')) {
		socket = new WebSocket('wss://' + location.host + '/ws');
	} else {
		socket = new WebSocket('ws://' + location.host + '/ws');
	}
	const doLogin = async () => {
		username = document.getElementById('login').value;
		let rq = JSON.stringify({ "method": "login", "params": { "login": username, "password": document.getElementById('pass').value } });
		socket.send(rq);
		socket.onmessage = function (event) {
			let res = JSON.parse(event.data);
			res = res['result'];

			if (res) {
				alert('ты вошол');
				document.getElementById('loginForm').hidden = true;
				document.getElementById('chat').hidden = false;
				document.getElementById('mesText').addEventListener("keyup", function (event) {

					if (event.keyCode === 13) {
						event.preventDefault();
						document.getElementById("send").click();
					}
				});
				socket.send(JSON.stringify({ "method": "messages", "params": {} }));
				socket.onmessage = chat;
			} else alert('неверный пASSворд или иди в жопу с таким паролем (делай от 6 символов)');
		}
	}
	const message = async () => {
		let rq = JSON.stringify({ "method": "message", "params": { "text": document.getElementById('mesText').value, "login": username } });
		socket.send(rq);
		document.getElementById('mesText').value = '';
	}
	const chat = (event) => {
		let res = JSON.parse(event.data);
		if (Object.keys(res).includes('message')) {
			document.getElementById('messages').innerHTML += (res['message']);
		} else if (Object.keys(res).includes('result')) {
			if (res['result']) {
				document.getElementById('messages').innerHTML = res['result'].join('');
			}
		}
	}
</script>

</html>