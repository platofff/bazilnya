<!DOCTYPE HTML>
<meta charset="utf-8">
<html>
<title>МЕТАПРОГ.ОНЛАЙН</title>
<header>
	<h1>
		Web клиент Метапрог.Онлайн
	</h1>
</header>

<body>
	<div id="loginForm">
		Введите данные своей учетной записи ВКонтакте для входа:
		<br>
		<input id="login" , placeholder="Номер телефона или логин">
		<br>
		<input id="pass" type="password" placeholder="Пароль">
		<br>
		<button onclick="doLogin()">Отправить</button>
	</div>
	<footer>
		Version 0.1.0 by AnImEsHnIk2281337
	</footer>
	<div id="chat" hidden="true">
		<input id="mesText"></input>
		<button onclick="message()" id="send">Отправить</button>
		<br>
		<div id="messages" style="overflow-y:auto;height:70%">
			<div>

			</div>
</body>


<script>
	let socket;
	if (window.location.href.includes('https://')) {
		socket = new WebSocket('wss://' + location.host + '/ws');
	} else {
		socket = new WebSocket('ws://' + location.host + '/ws');
	}
	let login, password;
	const doLogin = async () => {
		let rq = JSON.stringify({ "method": "login", "params": { "login": document.getElementById('login').value, "password": document.getElementById('pass').value } });
		socket.send(rq);
		socket.onmessage = function (event) {
			let res = JSON.parse(event.data);
			res = res['result'];

			if (res) {
				alert('ты вошол');
				login = document.getElementById('login').value;
				password = document.getElementById('pass').value;
				document.getElementById('loginForm').hidden = true;
				document.getElementById('chat').hidden = false;
				document.getElementById('mesText').addEventListener("keyup", function (event) {

					if (event.keyCode === 13) {
						event.preventDefault();
						document.getElementById("send").click();
					}
				});
				socket.onmessage = chat;
				getMessages();
			} else alert('неверный пASSворд');
		}
	}
	const message = async () => {
		let rq = JSON.stringify({ "method": "message", "params": { "login": login, "password": password, "text": document.getElementById('mesText').value } });
		socket.send(rq);
		document.getElementById('mesText').value = '';
	}
	const chat = (event) => {
		let res = JSON.parse(event.data);
		res = res['result'];

		document.getElementById('messages').innerHTML = res.join('<br>');
	}
	const getMessages = async () => {
		while (true) {
			await new Promise(resolve => setTimeout(resolve, 500))
			socket.send(JSON.stringify({ "method": "messages", "params": {} }));
		}
	}
</script>

</html>